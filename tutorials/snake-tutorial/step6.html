<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake - Step 6: Collision Detection</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1a1a2e;
            font-family: Arial, sans-serif;
            color: #eee;
        }
        canvas {
            background-color: #16213e;
            border: 4px solid #e94560;
            border-radius: 8px;
        }
        .score {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .instructions {
            margin-top: 20px;
            text-align: center;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="score">Score: <span id="scoreDisplay">0</span></div>
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <div class="instructions">
        Use Arrow Keys or WASD to control the snake<br>
        Don't hit the walls or yourself!
    </div>

    <script>
        // ============================================================
        // STEP 6: COLLISION DETECTION
        // ============================================================
        // Now we add the challenge: the snake can die!
        // Two types of collision:
        // 1. Wall collision - hitting the edge of the screen
        // 2. Self collision - running into your own body
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        
        // ============================================================
        // GAME CONSTANTS
        // ============================================================
        const GRID_SIZE = 20;
        const GRID_WIDTH = canvas.width / GRID_SIZE;
        const GRID_HEIGHT = canvas.height / GRID_SIZE;
        const GAME_SPEED = 150;
        
        // ============================================================
        // GAME STATE
        // ============================================================
        let snake = [
            { x: 10, y: 10 },
            { x: 9, y: 10 },
            { x: 8, y: 10 },
            { x: 7, y: 10 },
        ];
        
        let direction = { x: 1, y: 0 };
        let nextDirection = { x: 1, y: 0 };
        let food = { x: 15, y: 10 };
        let score = 0;
        
        // NEW: Game running state
        // We use this to stop the game when collision occurs
        let gameRunning = true;
        
        // ============================================================
        // NEW: COLLISION DETECTION FUNCTIONS
        // ============================================================
        
        /**
         * Checks if the snake's head has hit a wall.
         * Walls are the edges of our grid (0 to GRID_WIDTH-1, 0 to GRID_HEIGHT-1)
         * 
         * Returns true if collision occurred.
         */
        function checkWallCollision() {
            const head = snake[0];
            
            // Check each boundary
            // Left wall: x < 0
            // Right wall: x >= GRID_WIDTH (remember, valid range is 0 to 19 for 20 cells)
            // Top wall: y < 0
            // Bottom wall: y >= GRID_HEIGHT
            
            if (head.x < 0) {
                console.log('Hit left wall!');
                return true;
            }
            if (head.x >= GRID_WIDTH) {
                console.log('Hit right wall!');
                return true;
            }
            if (head.y < 0) {
                console.log('Hit top wall!');
                return true;
            }
            if (head.y >= GRID_HEIGHT) {
                console.log('Hit bottom wall!');
                return true;
            }
            
            return false;  // No wall collision
        }
        
        /**
         * Checks if the snake's head has hit its own body.
         * We compare the head position to every OTHER segment.
         * 
         * Returns true if collision occurred.
         */
        function checkSelfCollision() {
            const head = snake[0];
            
            // Check against each body segment (skip index 0, that's the head itself)
            // We use slice(1) to get all elements except the first
            const body = snake.slice(1);
            
            // Check if any body segment has the same position as the head
            const collision = body.some(segment => 
                segment.x === head.x && segment.y === head.y
            );
            
            if (collision) {
                console.log('Hit yourself!');
            }
            
            return collision;
        }
        
        /**
         * Master collision check function.
         * Checks all collision types and returns true if any occurred.
         */
        function checkCollisions() {
            return checkWallCollision() || checkSelfCollision();
        }
        
        /**
         * Called when the game ends due to collision.
         * For now, we just stop the game and log a message.
         * We'll add proper game over UI in the next step.
         */
        function gameOver() {
            gameRunning = false;
            console.log('GAME OVER! Final score:', score);
            
            // Draw "GAME OVER" text on the canvas
            ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#e94560';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('GAME OVER', canvas.width / 2, canvas.height / 2 - 20);
            
            ctx.fillStyle = '#eee';
            ctx.font = '24px Arial';
            ctx.fillText(`Score: ${score}`, canvas.width / 2, canvas.height / 2 + 20);
        }
        
        // ============================================================
        // FOOD FUNCTIONS (Same as Step 5)
        // ============================================================
        
        function spawnFood() {
            let newFood;
            let isOnSnake;
            
            do {
                newFood = {
                    x: Math.floor(Math.random() * GRID_WIDTH),
                    y: Math.floor(Math.random() * GRID_HEIGHT)
                };
                isOnSnake = snake.some(segment => 
                    segment.x === newFood.x && segment.y === newFood.y
                );
            } while (isOnSnake);
            
            food = newFood;
        }
        
        function isEatingFood() {
            const head = snake[0];
            return head.x === food.x && head.y === food.y;
        }
        
        function drawFood() {
            const pixelX = food.x * GRID_SIZE;
            const pixelY = food.y * GRID_SIZE;
            
            ctx.fillStyle = '#e94560';
            ctx.beginPath();
            ctx.arc(
                pixelX + GRID_SIZE / 2,
                pixelY + GRID_SIZE / 2,
                GRID_SIZE / 2 - 2,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            ctx.fillStyle = '#ff6b6b';
            ctx.beginPath();
            ctx.arc(pixelX + GRID_SIZE / 2 - 3, pixelY + GRID_SIZE / 2 - 3, 3, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // ============================================================
        // KEYBOARD INPUT (Same as before)
        // ============================================================
        
        function handleKeyPress(event) {
            switch (event.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    if (direction.y !== 1) nextDirection = { x: 0, y: -1 };
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    if (direction.y !== -1) nextDirection = { x: 0, y: 1 };
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    if (direction.x !== 1) nextDirection = { x: -1, y: 0 };
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    if (direction.x !== -1) nextDirection = { x: 1, y: 0 };
                    break;
            }
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
                event.preventDefault();
            }
        }
        
        document.addEventListener('keydown', handleKeyPress);
        
        // ============================================================
        // DRAWING FUNCTIONS
        // ============================================================
        
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        function drawCell(gridX, gridY, color) {
            const pixelX = gridX * GRID_SIZE;
            const pixelY = gridY * GRID_SIZE;
            ctx.fillStyle = color;
            ctx.fillRect(pixelX, pixelY, GRID_SIZE, GRID_SIZE);
            ctx.strokeStyle = '#16213e';
            ctx.lineWidth = 2;
            ctx.strokeRect(pixelX, pixelY, GRID_SIZE, GRID_SIZE);
        }
        
        function drawSnake() {
            snake.forEach((segment, index) => {
                const color = index === 0 ? '#4ecca3' : '#3aa389';
                drawCell(segment.x, segment.y, color);
            });
        }
        
        // ============================================================
        // UPDATE FUNCTIONS (Modified for collision)
        // ============================================================
        
        function moveSnake() {
            const head = snake[0];
            const newHead = {
                x: head.x + direction.x,
                y: head.y + direction.y
            };
            
            snake.unshift(newHead);
            
            if (isEatingFood()) {
                score += 10;
                scoreDisplay.textContent = score;
                spawnFood();
            } else {
                snake.pop();
            }
        }
        
        function update() {
            // Don't update if game is over
            if (!gameRunning) return;
            
            direction = nextDirection;
            moveSnake();
            
            // NEW: Check for collisions AFTER moving
            // We check after moving because we need to know where
            // the snake ended up, not where it was.
            if (checkCollisions()) {
                gameOver();
            }
        }
        
        function draw() {
            // Don't clear and redraw if game is over
            // (we want to keep the GAME OVER message visible)
            if (!gameRunning) return;
            
            clearCanvas();
            drawFood();
            drawSnake();
        }
        
        // ============================================================
        // GAME LOOP
        // ============================================================
        
        function gameLoop() {
            update();
            draw();
        }
        
        // ============================================================
        // START THE GAME
        // ============================================================
        spawnFood();
        draw();
        const gameInterval = setInterval(gameLoop, GAME_SPEED);
        
        // ============================================================
        // WHAT WE LEARNED IN THIS STEP:
        // ============================================================
        // 1. Wall collision: check if head is outside grid boundaries
        // 2. Self collision: check if head overlaps any body segment
        // 3. array.slice(1) gets all elements except the first
        // 4. We use a gameRunning flag to pause the game
        // 5. Collision is checked AFTER moving
        // 6. Drawing text on canvas with fillText()
        // 7. ctx.textAlign and ctx.textBaseline center text
        //
        // NEXT STEP: Proper game over with restart functionality!
        // ============================================================
        
        console.log('Step 6 Complete! Now the snake can die.');
        console.log('Try hitting a wall or growing long enough to hit yourself.');
    </script>
</body>
</html>
